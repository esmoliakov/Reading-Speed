@page "/quiz"
@using Shared.Models
@inject NavigationManager Navigation
@inject HttpClient HttpClient
@inject ReadingTimeService ReadingTimeService
<PageTitle>QUIZ</PageTitle>

<h1>QUIZ</h1>

@if (questions == null)
{
    <p>Loading questions...</p>
}
else
{
        @foreach (var question in questions)
        {
            <div class="question">
                <h4>@question.text</h4>
                @foreach (var option in question.options)
                {
                    <div>
                        <input type="radio" id="@option" name="q-@question.id" value="@option" 
                                   checked="@(question.userAnswer == option)" 
                                   @onchange="() => question.userAnswer = option" />
                            <label for="@option">@option</label>
                    </div>
                }
            </div>
        }
}


<div>
    <input type="text" @bind="userName" placeholder="Enter your name" />
</div>
<button class="btn btn-primary" @onclick="SubmitQuiz">Submit</button>


@code {

    private List<Question> questions;

    protected override async Task OnInitializedAsync()
    {
    
        // Fetch questions from the API
        questions = await HttpClient.GetFromJsonAsync<List<Question>>("/api/questions?fileName=sampleQuestions.json");
        
    }

    private string userName = string.Empty;
    private UserRecord? userResult;

    private async Task SubmitQuiz()
    {
        int correctCount = 0;
        foreach (var question in questions)
            {
            Console.WriteLine(question.userAnswer);
            if(question.correctAnswer.Equals(question.userAnswer))
                ++correctCount;
            }
        
        int questionCount = questions.Count();
        
        Console.WriteLine("Correct answers: " + correctCount + "/" + questionCount);

        double score = (double)correctCount / questionCount * 100;
        // simluating score for test purposes
        int quizScore = Convert.ToInt32(score);

        userResult = new UserRecord(userName, quizScore);

        // Save the UserRecord to local storage using ReadingTimeService
        await ReadingTimeService.SaveUserRecordAsync(userResult);

        Console.WriteLine(userResult.QuizScore + " " + userResult.Name);

        Navigation.NavigateTo("/results");
    }
}
